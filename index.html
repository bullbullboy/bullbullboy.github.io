<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>2DDarts v0.000.001</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

(function()
{

    function toRad(degree)
    {
        return degree * Math.PI / 180 ;
    };
    //各種調整用
    var ARM_WIDTH = 100;
    var ARM_HEIGHT = 0;
    var DART_WIDTH = 16;
    var DART_HEIGHT = 16;

    //フォーム調整用    
    var TIME_RATE =1;   //全体の速度はここで調整
    var SETTING_SHOULDER_ANG_VEL = -1 * TIME_RATE;
    var BENDING_ELBOW_ANG_VEL = -3 * TIME_RATE;
    var THROWING_SHOULDER_ANG_VEL = -2 * TIME_RATE;
    var THROWING_ELBOW_ANG_VEL = 10 * TIME_RATE;

    var VELOCITY_FIRST = 12;
    var GRAVITY = 0.15;

    //Armクラス-----------------------

    var State = {Set:0, RaisingArm:1, BendingElbow:2, Throwing:3, Finished:4, Max:5};

    Arm = function(shootDartFunc)
    {
        this.initialize(shootDartFunc);
        this.init();
    };

    Arm.prototype.handPos = function()
    {
        var xPos = this.shoulderPos.x + ARM_WIDTH * Math.cos(toRad(this.upperArm.angle)) + ARM_WIDTH * Math.cos(toRad(this.foreArm.angle));
        var yPos = this.shoulderPos.y + ARM_WIDTH * Math.sin(toRad(this.upperArm.angle)) + ARM_WIDTH * Math.sin(toRad(this.foreArm.angle));
        return {x: xPos, y: yPos};
    };

    Arm.prototype.dartsAngle = function()
    {
        return toRad((this.foreArm.angle + 90));
    };

    Arm.prototype.ToNextState = function()
    {
        //TODO Stateパターン
        switch(this.state)
        {

            // case State.RaiseArm:
            // break;

            case State.BendingElbow:
                var hand = this.handPos();
                this.throwDart(hand.x, hand.y, this.dartsAngle());//TODO:角度
                //TODO:共通化
                this.state++;
                this.state = this.state % State.Max;
                break;

            // case State.Throw:
            // break;

            // case State.Finished:
            // break;
            case State.Throwing:
                //Do Nothing
                break;

            default:
                this.nextState();
                break;
        }
    };

    Arm.prototype.Update = function()
    {
        this.refreshRelativeAngles();
        this.refreshArmAngles();
        this.refreshImage();
    };

    Arm.prototype.refreshRelativeAngles = function()
    {
        //TODO Stateパターン
        switch(this.state)
        {
            case State.Set:
                this.init();
                break;
            case State.RaisingArm:
                this.shoulderAngle += SETTING_SHOULDER_ANG_VEL;
                break;

            case State.BendingElbow:
                this.elbowAngle += BENDING_ELBOW_ANG_VEL;
                break;

            case State.Throwing:
                this.shoulderAngle += THROWING_SHOULDER_ANG_VEL;
                this.elbowAngle += THROWING_ELBOW_ANG_VEL;

                if(this.elbowAngle >= 0)
                {
                    this.state++;
                    this.elbowAngle = 0;
                }
                break;

            case State.Finished:
                break;

            default:
                break;
        }

    };

    Arm.prototype.refreshArmAngles = function()
    {
        this.upperArm.angle = this.shoulderAngle;
        this.foreArm.angle = this.upperArm.angle + this.elbowAngle;
    };

    Arm.prototype.initialize = function(shootFunc)
    {
        this.throwDart = shootFunc;
        this.upperArm = game.add.image(0, 0, 'upperArm');
        this.foreArm = game.add.image(0, 0, 'foreArm');

        //回転軸の指定
        this.upperArm.anchor = new Phaser.Point(0, 0.5);
        this.foreArm.anchor = new Phaser.Point(0, 0.5);
    };

    Arm.prototype.init = function()
    {
        this.shoulderAngle = 80;
        this.elbowAngle = 0;
        this.state = State.Set;
        this.shoulderPos = new Phaser.Point(100, 200);
    };

    Arm.prototype.refreshImage = function()
    {
        this.upperArm.position = new Phaser.Point(
            this.shoulderPos.x, this.shoulderPos.y);
        this.foreArm.position = new Phaser.Point(
            this.shoulderPos.x + ARM_WIDTH * Math.cos(toRad(this.upperArm.angle)),
            this.shoulderPos.y + ARM_WIDTH * Math.sin(toRad(this.upperArm.angle)));
    };

    Arm.prototype.nextState = function()
    {
        this.state++;
        this.state = this.state % State.Max;
    };

    //-Armここまで----------------------------
    //Dart
    Dart = function(x0, y0, angle0)
    {
        //TODO:初速は外からもらうべき？仮実装
        

        this.vx = VELOCITY_FIRST * Math.cos(angle0);
        this.vy = VELOCITY_FIRST * Math.sin(angle0);
        this.angle = angle0;
        this.image = game.add.image(x0, y0, 'dartImg')
    };

    Dart.prototype.Update = function()
    {
        this.image.position.x += this.vx;   
        this.image.position.y += this.vy;

        this.vy += GRAVITY;
    };

    //DartShooter----------------------------
    //TODO:名前。Factory的に作ったが・・・管理もしてるし・・・
    DartShooter = function()
    {
        this.dartsList = new Array();
    };

    DartShooter.prototype.Shoot = function(x, y, angle)
    {
        //TODO:おためし中
        this.dartsList.push(new Dart(x, y, angle));        
    };

    DartShooter.prototype.UpdateAllDart = function()
    {
        for(var i = 0; i < this.dartsList.length; i++)
        {
            this.dartsList[i].Update();
        }
    };

    //----main-------------------------
    var game = new Phaser.Game(800, 480, Phaser.AUTO, '', { preload: preload, create: create, update: update });
    var arm;
    var dartShooter;

    function preload() {
        game.load.image('foreArm', 'assets/armFig.png');
        game.load.image('upperArm', 'assets/armFig.png');
        game.load.image('dartImg', 'assets/dartImg.png');
    }

    function create() {
        game.stage.backgroundColor = "000000";
        dartShooter = new DartShooter();
        arm = new Arm(dartShooter.Shoot.bind(dartShooter));
    }

    var isClickOn = false;
    var isClickOnPrev = false;
    function update() {
        arm.Update();
        dartShooter.UpdateAllDart();

        //TODO:クリックどうやるんだ
        if (game.input.activePointer.isDown)
        {
            isClickOn = true;
        }

        if (game.input.activePointer.isUp)
        {
            isClickOn = false;
        }

        //OnEdgeをとる
        if(isClickOn && !isClickOnPrev)
        {
            arm.ToNextState();
        }
        isClickOnPrev = isClickOn;
    }

})();

</script>

</body>
</html>