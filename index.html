<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

(function()
{

    function toRad(degree)
    {
        return degree * Math.PI / 180 ;
    };

    //Armクラス-----------------------
    var ARM_WIDTH = 100;
    var ARM_HEIGHT = 0;
    var DART_WIDTH = 16;
    var DART_HEIGHT = 16;

    //TODO:大文字にする
    var State = {Set:0, RaiseArm:1, BendElbow:2, Throw:3, Finished:4, Max:5};

    Arm = function(shootDartFunc)
    {
        //TODO:初期化をどこかで統一
        this.state = State.RaiseArm;
        this.throwDart = shootDartFunc;

        this.shoulderPos = new Phaser.Point(100, 200);
        this.shoulderAngle = 0;
        this.elbowAngle = 0;
        this.upperArm = game.add.image(0, 0, 'upperArm');
        this.foreArm = game.add.image(0, 0, 'foreArm');

        //回転軸の指定
        this.upperArm.anchor = new Phaser.Point(0, 0.5);
        this.foreArm.anchor = new Phaser.Point(0, 0.5);

        this.init();
    };

    //TODO:改名
    Arm.prototype.ToNextAction = function()
    {
        //TODO Stateパターン
        switch(this.state)
        {

            // case State.RaiseArm:
            // break;

            case State.BendElbow:
                this.throwDart(100,100,10);//TODO:その時の値を入れる
                //TODO:共通化
                this.state++;
                this.state = this.state % State.Max;
                break;

            // case State.Throw:
            // break;

            // case State.Finished:
            // break;
            case State.Throw:
                //Do Nothing
                break;

            default:
                this.state++;
                this.state = this.state % State.Max;
                break;
        }
    };

    //TODO:改名
    Arm.prototype.ToNext = function()
    {
        this.refreshRelativeAngles();
        this.refreshArmAngles();
        this.refreshImage();
    };

    var TIME_RATE =1;
    var SETTING_SHOULDER_ANG_VEL = -1 * TIME_RATE;
    var BENDING_ELBOW_ANG_VEL = -3 * TIME_RATE;
    var THROWING_SHOULDER_ANG_VEL = -2 * TIME_RATE;
    var THROWING_ELBOW_ANG_VEL = 10 * TIME_RATE;

    Arm.prototype.refreshRelativeAngles = function()
    {
        //TODO Stateパターン
        switch(this.state)
        {
            case State.Set:
                this.init();
                break;
            case State.RaiseArm:
                this.shoulderAngle += SETTING_SHOULDER_ANG_VEL;
                break;

            case State.BendElbow:
                this.elbowAngle += BENDING_ELBOW_ANG_VEL;
                break;

            case State.Throw:
                this.shoulderAngle += THROWING_SHOULDER_ANG_VEL;
                this.elbowAngle += THROWING_ELBOW_ANG_VEL;

                if(this.elbowAngle >= 0)
                {
                    this.state++;
                    this.elbowAngle = 0;
                }
                break;

            case State.Finished:
                break;

            default:
                break;
        }

    };

    Arm.prototype.refreshArmAngles = function()
    {
        this.upperArm.angle = this.shoulderAngle;
        this.foreArm.angle = this.upperArm.angle + this.elbowAngle;
    };

    Arm.prototype.init = function()
    {
        this.shoulderAngle = 80;
        this.elbowAngle = 0;
        this.state = State.Set;
    };

    Arm.prototype.refreshImage = function()
    {
        this.upperArm.position = new Phaser.Point(
            this.shoulderPos.x, this.shoulderPos.y);
        this.foreArm.position = new Phaser.Point(
            this.shoulderPos.x + ARM_WIDTH * Math.cos(toRad(this.upperArm.angle)),
            this.shoulderPos.y + ARM_WIDTH * Math.sin(toRad(this.upperArm.angle)));
    };

    //-Armここまで----------------------------

    //DartShooter----------------------------
    DartShooter = function()
    {
    };

    DartShooter.prototype.Shoot = function(x, y, angle)
    {
        //TODO:おためし中
        game.add.image(x, y, 'dartImg');
    };


    //----main-------------------------
    var game = new Phaser.Game(800, 480, Phaser.AUTO, '', { preload: preload, create: create, update: update });
    var arm;
    var dartShooter;

    function preload() {
        game.load.image('foreArm', 'assets/armFig.png');
        game.load.image('upperArm', 'assets/armFig.png');
        game.load.image('dartImg', 'assets/dartImg.png');
    }

    function create() {
        game.stage.backgroundColor = "000000";
        //TODO:armに改名
        dartShooter = new DartShooter();
        arm = new Arm(function(){ dartShooter.Shoot();});
    }

    var isClickOn = false;
    var isClickOnPrev = false;
    function update() {
        arm.ToNext();

        //TODO:クリックどうやるんだ
        if (game.input.activePointer.isDown)
        {
            isClickOn = true;
        }

        if (game.input.activePointer.isUp)
        {
            isClickOn = false;
        }

        //OnEdgeをとる
        if(isClickOn && !isClickOnPrev)
        {
            arm.ToNextAction();
        }
        isClickOnPrev = isClickOn;
    }

})();

</script>

</body>
</html>